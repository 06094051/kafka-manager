@*
* Copyright 2015 Yahoo Inc. Licensed under the Apache License, Version 2.0
* See accompanying LICENSE file.
*@

@import scalaz.{\/}
@import b3.vertical.fieldConstructor
@import kafka.manager.ActorModel.{TopicIdentity, BVView}
@import kafka.manager.{BrokerListExtended}
@import kafka.manager.utils._
@import helper._
@import models.form._

@(cluster: String,
  assignForm: Form[List[(String, List[(Int,List[Int])])]],
  brokers: BrokerListExtended,
  brokersViews: Seq[BVView],
  formErrors: Seq[FormError]
)

@theMenu = {
@views.html.navigation.clusterMenu(cluster,"Topic","Manual Partition Assignments",models.navigation.Menus.clusterMenus(cluster))
}

@replicaSelection(brokerField: Field) = {
    <select name="@brokerField.name">
        @for(idx <- 0 until brokers.list.size) {
            <option value="@idx" @if(idx == brokerField.value.get.toInt){selected}>Broker @idx</option>
        }
    </select>
}

@partitionsAssignmentsPane = {
<div class="panel panel-default">
    <div class="panel-heading">
        <h3>
            <button type="button" class="btn btn-link" onclick="goBack()">
                <span class="glyphicon glyphicon-arrow-left" aria-hidden="true"></span>
            </button>
            Manual Partition Assignments
            <button class="btn btn-primary float-right" type="submit">Save Partition Assignment</button>
        </h3>
    </div>
    <div class="panel-body assignment-pane">
        @repeat(assignForm("topics")) { partitionAssignment =>
        <div class="assignment-cell">
            <h3>
            <input type="text" class="borderless center-text"
                   name='@partitionAssignment("topic").name'
                   value='@partitionAssignment("topic").value.get' readonly/>
            </h3>
            <table>
                @repeat(partitionAssignment("assignments")) { assignment =>
                    @if(assignment("partition").value.isDefined) {
                        @repeatWithIndex(assignment("brokers")) { (broker, index) =>
                                @if(index == 0) {
                                    <tr>
                                    <th>Partition
                                        <input type="number" class="borderless"
                                           name='@assignment("partition").name'
                                           value='@assignment("partition").value.get'
                                           readonly>
                                    </th>
                                    </tr>
                                }
                            <tr>
                                <td>Replica @index: @replicaSelection(broker)</td>
                            </tr>
                        }
                    }
                }
            </table>
        </div>
        }
    </div>
</div>
}

@brokersInfoPane = {
    @for(idx <- 0 until brokersViews.size) {
        <h4 class="alert alert-info">Broker @idx</h4>
        @views.html.common.brokerMetrics(brokersViews(idx).metrics)
    }
}

@main(
  "Manual Multiple Assignment",
  menu = theMenu,
  breadcrumbs=views.html.navigation.breadCrumbs(models.navigation.BreadCrumbs.withViewAndCluster("Topics",cluster))) {
<div class="row">
    <div class="col-md-8">
        @if(brokers != null) {
            @helper.form(action = routes.ReassignPartitions.handleManualAssignment(cluster)) {
                @partitionsAssignmentsPane
            }
        } else {
            @assignForm.toString
            <br/><br/><br/><br/><br/>
            @formErrors.toString
        }
    </div>
    <div class="col-md-4">
        @if(brokers != null) {
            @brokersInfoPane
        }
    </div>
</div>
}
